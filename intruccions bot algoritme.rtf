{\rtf1\ansi\ansicpg1252\cocoartf2706
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fswiss\fcharset0 Helvetica;\f1\fnil\fcharset0 LucidaGrande;\f2\fnil\fcharset0 AppleColorEmoji;
\f3\fnil\fcharset134 PingFangSC-Regular;}
{\colortbl;\red255\green255\blue255;}
{\*\expandedcolortbl;;}
\paperw11900\paperh16840\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural\partightenfactor0

\f0\fs24 \cf0 ############################################################\
MisCEREbot \'96 Fulla de ruta detallada i document d\'92estil complet\
############################################################\
\
PROJECTE: MisCEREbot \'96 Bot de Telegram d\'92investigaci\'f3 acad\'e8mica sobre la Ribera d\'92Ebre\
DATA: 2025-10-11\
AUTOR: [CalBarber]\
\
== OBJECTIU ==\
Crear un bot de Telegram amb IA (RAG + LLM) per cercar, resumir i comparar articles acad\'e8mics sobre la comarca de la Ribera d\'92Ebre. Ha de permetre sessions d\'92usuari, paginaci\'f3, diferents modes (Conversa, Cerca, Investigaci\'f3, Mix, Amplia), filtratge per poble i generaci\'f3 de resums o llistats. Ha de funcionar en catal\'e0, amb m\'ednimes depend\'e8ncies per desplegament a Railway.\
\
== CORPUS I FORMAT DE DADES ==\
- Fitxer: corpus_original.jsonl\
- Exemple de registre:\
\{\
  "id": 23,\
  "title": "Castell de Miravet",\
  "author": "Jgfdsgsg",\
  "population": "Ginestar",\
  "topics": ["Guerra de Successi\'f3", "Decrets de Nova Planta"],\
  "language": "Catal\'e0",\
  "years": "1660-1795",\
  "filename": "adminRACO,+MCERE_20+049+Marques_Risbourg.pdf",\
  "summary_long": "Text llarg de resum de l'article...",\
  "summary": "Resum curt..."\
\}\
- Llista de pobles admesos (exacta, per filtratge):\
["Asc\'f3","Benissanet","Flix","Garcia","Ginestar","Miravet",\
"M\'f3ra d'Ebre","M\'f3ra la Nova","Palma d'Ebre, la",\
"Rasquera","Riba-roja d'Ebre","Tivissa",\
"Torre de l'Espanyol, la","Vinebre"]\
\
== ARQUITECTURA GLOBAL ==\
COMPONENTS:\
- Intent Router (LLM): detecta mode segons comanda o text lliure\
- Retrieval Layer: cerca sem\'e0ntica amb FAISS + filtratge per poble opcional\
- Response Composer: genera respostes finals (resum, llistat, Mix, Amplia)\
- Session Manager: sessions per user_id amb timeout 1h\
- Core RAG modular: integra components i gestiona flux\
- Telegram Bot API: interf\'edcie de conversa\
\
TECNOLOGIES:\
- Python 3.11\
- openai >= 1.0\
- faiss-cpu\
- numpy\
- python-telegram-bot\
- dotenv\
\
== EMBEDDINGS I FAISS ==\
- Embeddings ja pre-generats amb OpenAI (text-embedding-3-small)\
- Text per embedding: population + topics + title + summary + summary_long, limit 2000 car\'e0cters\
- Fitxer: embeddings_G.npy\
- FAISS Index amb IDs: faiss_index_G.index\
- Filtratge per poble abans de cercar (sub-index nom\'e9s amb articles del poble, si s\'92indica)\
\
== CERCA SEM\'c0NTICA (funci\'f3 query_faiss) ==\
- Entrada: user_query (text), poble opcional, exclude_ids opcional, top_k\
- Proc\'e9s:\
  1. Genera embedding de la query (text-embedding-3-small)\
  2. Filtra articles per poble (si especificat)\
  3. Exclou articles ja retornats (exclude_ids)\
  4. Crea sub-index FAISS amb embeddings filtrats\
  5. Retorna top_k resultats amb score calculat: score = 1 / (1 + dist)\
- Sortida: llista de tuples (document, score)\
\
== SESSI\'d3 I GESTI\'d3 DE MODES ==\
- session = dict amb user_id com a clau\
- Cont\'e9: mode, topic, poble, articles mostrats, p\'e0gina actual, selected_id, last_update\
- Timeout: 1h d\'92inactivitat 
\f1 \uc0\u8594 
\f0  reinicia autom\'e0ticament\
- Modes:\
  1. Conversa 
\f1 \uc0\u8594 
\f0  respostes curtes i informals, sense header/footer. Detecta preguntes factuals 
\f1 \uc0\u8594 
\f0  canvia a Cerca\
  2. Cerca 
\f1 \uc0\u8594 
\f0  filtratge per poble + embedding + FAISS, retorna resum o llistat top_k\
  3. Investigaci\'f3 
\f1 \uc0\u8594 
\f0  /id, mostra summary_long, paginaci\'f3 2500c, cerca dins article\
  4. Mix 
\f1 \uc0\u8594 
\f0  /mix id1 id2 [tema], resum per article + conclusi\'f3 comuna, \uc0\u8804 3500c\
  5. Amplia 
\f1 \uc0\u8594 
\f0  /amplia, mant\'e9 tema/poble, cerca info nova excloent articles mostrats, \uc0\u8804 3500c\
\
== FORMATS DE RESPOSTA ==\
- Cerca resum general:\
[Mode: Cerca]\
[Tasca: Resum | Tema: \{topic\} | Poble: \{poble\}]\
<resum text>\
P\'e0g. 1 de N. /mes per continuar\
Articles consultats:\
/23 Castell de Miravet (Pes: 12,5)\
/14 Coves del Salt de la Gl\'f2ria (Pes: 2,7)\
- Investigaci\'f3:\
[Mode: Investigaci\'f3]\
[Tema: /23 \'96 Castell de Miravet]\
<summary_long paginat>\
P\'e0g. 1 de X. /mes per continuar\
/nou per canviar de tema\
- Mix:\
[Mode: Mix]\
[Tasca: Mix | Tema: Arqueologia]\
**Article 23 \'96 Castell de Miravet**\
Resum breu...\
**Article 9 \'96 Excavacions de Ginestar**\
Resum breu...\
**Conclusi\'f3 comuna**\
Text...\
- Amplia:\
[Mode: Cerca]\
[Tasca: Amplia | Tema: \{tema\} | Poble: \{poble\}]\
<resum nou o ampliaci\'f3>\
\
== PAGINACI\'d3 ==\
- Missatge m\'e0xim: 2500 car\'e0cters (3500 Mix/Amplia)\
- Format peu: P\'e0g. X de Y /mes\
- La sessi\'f3 recorda p\'e0gina per user_id\
\
== COMANDES PRINCIPALS ==\
/start 
\f1 \uc0\u8594 
\f0  inicia sessi\'f3 i mostra benvinguda\
/ajuda 
\f1 \uc0\u8594 
\f0  mostra ordres i modes\
/nou 
\f1 \uc0\u8594 
\f0  reinicia context\
/mes 
\f1 \uc0\u8594 
\f0  mostra p\'e0gina seg\'fcent\
/poble X 
\f1 \uc0\u8594 
\f0  canvia filtre de poble\
/tots o /ribera 
\f1 \uc0\u8594 
\f0  cerca en tot el corpus\
/mix id1 id2 [tema] 
\f1 \uc0\u8594 
\f0  mode Mix amb tema\
/amplia 
\f1 \uc0\u8594 
\f0  amplia \'faltima resposta\
/id 
\f1 \uc0\u8594 
\f0  mostra resum llarg d\'92un article concret\
\
== DETALLS T\'c8CNICS ADDICIONALS ==\
- Embeddings inclouen population + topics + title + summary + summary_long\
- Scores mostrats al footer, llista d\'92articles clicable via /id\
- Logs a consola: missatge usuari + [ids dels articles consultats]\
- Conversa detecta mode autom\'e0ticament segons intenci\'f3\
- Sessions nom\'e9s en mem\'f2ria, reinici autom\'e0tic despr\'e9s de 1h\
- Evita repetir articles en /amplia i Mix\
- Footer llista articles top_k per score, format clicable: /id T\'edtol (Pes: X,X)\
\
== EXEMPLES ==\
- Cerca amb poble:\
/asco arqueologia 
\f1 \uc0\u8594 
\f0  busca articles sobre arqueologia a Asc\'f3\
- Mix amb tema:\
/mix 23 9 arqueologia 
\f1 \uc0\u8594 
\f0  compara articles 23 i 9 amb resum + conclusi\'f3\
- Amplia:\
/amplia 
\f1 \uc0\u8594 
\f0  afegeix informaci\'f3 nova al tema anterior\
- Investigaci\'f3:\
/23 
\f1 \uc0\u8594 
\f0  mostra summary_long de l\'92article 23\
\
== POSSIBLES EXTENSIONS FUTURES ==\
- Sessions persistents amb Redis\
- Multiling\'fce /english amb traducci\'f3 din\'e0mica LLM\
- Logging avan\'e7at amb timestamps i metadades\
- Optimitzaci\'f3 FAISS per filtres i top_k din\'e0mic\
- Interf\'edcie web/API per consulta remota\
\
== PREGUNTES OBERTES PER DECISIONS FUTURES ==\
- Traducci\'f3 din\'e0mica i suport angl\'e8s\
- Integraci\'f3 Redis\
- Limitaci\'f3 de tokens i cost OpenAI\
\
== CONCLUSI\'d3 ==\
Fulla de ruta completa per al desenvolupament del bot Telegram MisCEREbot. Inclou:\
- Corpus i format detallat\
- Llista completa de pobles admesos\
- Embeddings i FAISS pre-generats\
- Modes i comandes definits amb detall\
- Paginaci\'f3, resums, llistats i footer clicable\
- Logs de consola b\'e0sics\
- Possibles extensions per escalabilitat i multiling\'fce\
\
############################################################\
Fi del document\
############################################################\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
############################################################\
# MisCEREbot \'96 Especificaci\'f3 completa i arquitectura funcional\
# Bot de Telegram d'investigaci\'f3 acad\'e8mica sobre la Ribera d\'92Ebre\
############################################################\
\
# ----------------------------------------------------------\
# 1. OBJECTIU\
# ----------------------------------------------------------\
# Crear un bot de Telegram amb IA (RAG + LLM) capa\'e7 de cercar,\
# resumir i comparar articles acad\'e8mics sobre la comarca\
# de la Ribera d\'92Ebre, a partir d\'92un corpus JSON estructurat.\
\
# ----------------------------------------------------------\
# 2. CORPUS I FORMAT DE DADES\
# ----------------------------------------------------------\
# Fitxer: corpus_original.jsonl\
# Exemple de registre:\
# \{\
#   "id": 23,\
#   "title": "Castell de Miravet",\
#   "author": "Jgfdsgsg",\
#   "population": "Ginestar",\
#   "topics": ["Guerra de Successi\'f3", "Decrets de Nova Planta"],\
#   "language": "Catal\'e0",\
#   "years": "1660-1795",\
#   "filename": "adminRACO,+MCERE_20+049+Marques_Risbourg.pdf",\
#   "summary_long": "Text llarg de resum...",\
#   "summary": "Resum curt..."\
# \}\
\
# POBLES ADMESOS:\
# ["Asc\'f3","Benissanet","Flix","Garcia","Ginestar","Miravet",\
#  "M\'f3ra d'Ebre","M\'f3ra la Nova","Palma d'Ebre, la",\
#  "Rasquera","Riba-roja d'Ebre","Tivissa",\
#  "Torre de l'Espanyol, la","Vinebre"]\
\
# Nombre d'articles: ~100\
# Cada article t\'e9 un identificador \'fanic (id / idx).\
\
# ----------------------------------------------------------\
# 3. ARQUITECTURA GLOBAL\
# ----------------------------------------------------------\
# COMPONENTS:\
#   - Intent Router (LLM): interpreta l\'92ordre o pregunta.\
#   - Retrieval Layer (FAISS + embeddings): cerca sem\'e0ntica.\
#   - Response Composer: genera la resposta final segons l\'92intent.\
#   - Session Manager: gestiona estat per user_id (amb timeout 1h).\
#   - Core RAG modular: integra tots els components.\
#   - Telegram Bot API: interf\'edcie de conversa.\
\
# TECNOLOGIES:\
#   - Python 3.x\
#   - openai >= 1.0\
#   - faiss-cpu\
#   - numpy\
#   - python-telegram-bot\
#   - dotenv\
\
# ----------------------------------------------------------\
# 4. GENERACI\'d3 D\'92EMBEDDINGS I FAISS\
# ----------------------------------------------------------\
\
import json, os, time\
import numpy as np\
import faiss\
import openai\
from dotenv import load_dotenv\
\
# ---------- CONFIG ----------\
load_dotenv()\
openai.api_key = os.getenv("OPENAI_API_KEY")\
\
DATA_DIR = "../../MisCEREbot/data"\
CORPUS_FILE = os.path.join(DATA_DIR, "corpus_original.jsonl")\
EMBEDDINGS_FILE = os.path.join(DATA_DIR, "embeddings_G.npy")\
FAISS_INDEX_FILE = os.path.join(DATA_DIR, "faiss_index_G.index")\
\
# ---------- CARREGA CORPUS ----------\
docs = []\
with open(CORPUS_FILE, "r", encoding="utf-8") as f:\
    for line in f:\
        if line.strip():\
            docs.append(json.loads(line))\
print(f"Carregat corpus: \{len(docs)\} documents")\
\
# ---------- GENERA EMBEDDINGS ----------\
embeddings = []\
for i, doc in enumerate(docs):\
    text_parts = [doc.get("population","")] + doc.get("topics", []) + [\
        doc.get("title",""), doc.get("summary",""), doc.get("summary_long","")\
    ]\
    text = " ".join([t for t in text_parts if t])[:2000]\
\
    print(f"[\{i\}] Generant embedding: \{doc.get('title','')[:40]\}...")\
    try:\
        resp = openai.embeddings.create(\
            model="text-embedding-3-small",\
            input=text\
        )\
        emb = np.array(resp.data[0].embedding, dtype=np.float32)\
        embeddings.append(emb)\
    except Exception as e:\
        print(f"
\f2 \uc0\u9888 \u65039 
\f0  Error generant embedding per document \{i\}: \{e\}")\
        embeddings.append(np.zeros(1536, dtype=np.float32))\
\
embeddings = np.vstack(embeddings)\
np.save(EMBEDDINGS_FILE, embeddings)\
print(f"
\f2 \uc0\u9989 
\f0  Guardats embeddings: \{embeddings.shape\}")\
\
# ---------- CREA FAISS INDEX ----------\
dimension = embeddings.shape[1]\
index = faiss.IndexIDMap(faiss.IndexFlatL2(dimension))\
index.add_with_ids(embeddings, np.arange(len(docs)))\
faiss.write_index(index, FAISS_INDEX_FILE)\
print(f"
\f2 \uc0\u9989 
\f0  FAISS index creat amb \{index.ntotal\} vectors")\
\
\
# ----------------------------------------------------------\
# 5. CERCADOR SEM\'c0NTIC\
# ----------------------------------------------------------\
def query_faiss(user_query, poble=None, exclude_ids=None, top_k=10):\
    """\
    Cerca h\'edbrida (sem\'e0ntica + filtre per poble)\
    Retorna llista de (document, score)\
    """\
    exclude_ids = exclude_ids or []\
\
    resp = openai.embeddings.create(\
        model="text-embedding-3-small",\
        input=user_query\
    )\
    query_vector = np.array(resp.data[0].embedding, dtype=np.float32).reshape(1, -1)\
\
    candidate_docs = [\
        (i, d) for i, d in enumerate(docs)\
        if (poble is None or d.get("population","").lower() == poble.lower())\
        and (i not in exclude_ids)\
    ]\
    if not candidate_docs:\
        return []\
\
    idxs = [i for i, _ in candidate_docs]\
    sub_vectors = np.array([embeddings[i] for i in idxs])\
    sub_index = faiss.IndexFlatL2(sub_vectors.shape[1])\
    sub_index.add(sub_vectors)\
    D, I = sub_index.search(query_vector, top_k)\
\
    results = []\
    for dist, sub_i in zip(D[0], I[0]):\
        real_idx = idxs[sub_i]\
        score = float(1 / (1 + dist))\
        results.append((docs[real_idx], score))\
    return results\
\
\
# ----------------------------------------------------------\
# 6. GESTI\'d3 DE MODES I SESSI\'d3\
# ----------------------------------------------------------\
session = \{\}\
\
def reset_session(user_id):\
    session[user_id] = \{\
        "mode": "cerca",\
        "topic": None,\
        "poble": "Tots",\
        "articles": [],\
        "page": 1,\
        "selected_id": None,\
        "last_update": time.time()\
    \}\
\
def session_expired(user_id, timeout=3600):\
    return (time.time() - session.get(user_id, \{\}).get("last_update", 0)) > timeout\
\
\
# ----------------------------------------------------------\
# 7\'9612. M\'d2DULS DE FUNCIONAMENT I FLUXS\
# ----------------------------------------------------------\
# (mant\'e9 tota la secci\'f3 de modes, comandes, flux de transicions i diagrama l\'f2gic)\
# Amb les seg\'fcents clarificacions finals:\
#\
# - /amplia 
\f1 \uc0\u8594 
\f0  nova cerca FAISS del mateix tema, excloent articles ja mostrats.\
# - Si no troba nova informaci\'f3 
\f1 \uc0\u8594 
\f0  \'93No hi ha m\'e9s resultats per ampliar.\'94\
# - Timeout de sessi\'f3: 1h d\'92inactivitat 
\f1 \uc0\u8594 
\f0  reinicia autom\'e0ticament.\
# - Missatges truncats a 2500/3500 car\'e0cters segons mode.\
# - Mode conversa sense header/footer, resta amb format fix.\
\
# ----------------------------------------------------------\
# 7. M\'d2DULS DE FUNCIONAMENT\
# ----------------------------------------------------------\
\
## Mode: Conversa\
# - Respostes curtes i informals\
# - Sense header ni footer\
# - Si detecta una pregunta factual o sobre tema espec\'edfic (\'93qu\'e8 saps de...\'94, \'93explica\'92m...\'94)\
#   
\f1 \uc0\u8594 
\f0  passa autom\'e0ticament a mode Cerca\
\
## Mode: Cerca\
# Entrada t\'edpica:\
#   /asco arqueologia\
#   /mora guerra civil\
#   \'93Qu\'e8 se sap de la guerra dels carlins a Miravet?\'94\
#\
# Proc\'e9s:\
#   - Detecta poble (\'93Asc\'f3\'94, \'93Miravet\'94, etc.) i tema (\'93arqueologia\'94, \'93guerra civil\'94, etc.)\
#   - Genera embedding de la consulta\
#   - Aplica filtre FAISS per poble\
#   - Retorna top_k resultats ordenats per score\
#   - Genera resum unificat dels resultats (\uc0\u8804 2500 car\'e0cters)\
#\
# Format de resposta:\
#   [Mode: Cerca]\
#   [Tasca: Resum | Tema: \{topic\} | Poble: \{poble\}]\
#   <resum>\
#   P\'e0g. 1 de N. /mes per continuar\
#   Articles consultats:\
#   /23 Castell de Miravet (Pes: 12,5)\
#   /14 Coves del Salt de la Gl\'f2ria (Pes: 2,7)\
#\
# Transicions possibles:\
#   /id 
\f1 \uc0\u8594 
\f0  entra a mode Investigaci\'f3\
#   /mix 
\f1 \uc0\u8594 
\f0  entra a mode Mix\
#   /amplia 
\f1 \uc0\u8594 
\f0  entra a mode Amplia\
#   /nou 
\f1 \uc0\u8594 
\f0  reinicia context\
\
## Mode: Investigaci\'f3\
# Entrada t\'edpica: /23\
#   
\f1 \uc0\u8594 
\f0  Mostra summary_long de l\'92article (paginat)\
#\
# Format:\
#   [Mode: Investigaci\'f3]\
#   [Tema: /23 \'96 Castell de Miravet]\
#   <resum o resultat de cerca dins de l\'92article>\
#   P\'e0g. 1 de 4. /mes per continuar\
#   /nou per canviar de tema\
#\
# Funcionalitat extra:\
#   - Pregunta dins del context: cerca interna al summary_long\
#   - Sortida del mode:\
#       /nou 
\f1 \uc0\u8594 
\f0  torna a Cerca\
#       /mix ... 
\f1 \uc0\u8594 
\f0  passa a Mix\
#       /amplia 
\f1 \uc0\u8594 
\f0  passa a Amplia\
\
## Mode: Mix\
# Entrada t\'edpica: /mix 23 9 arqueologia\
#\
# Proc\'e9s:\
#   - Llegeix articles indicats (23 i 9)\
#   - Si no s\'92indica tema, detecta el com\'fa entre els articles\
#   - Genera resum per article + conclusi\'f3 final (\uc0\u8804 3500 car\'e0cters)\
#\
# Format:\
#   [Mode: Mix]\
#   [Tasca: Mix | Tema: Arqueologia]\
#   **Article 23 \'96 Castell de Miravet**\
#   Resum breu...\
#   **Article 9 \'96 Excavacions de Ginestar**\
#   Resum breu...\
#   **Conclusi\'f3 comuna**\
#   Text...\
#\
# Sortida:\
#   /amplia 
\f1 \uc0\u8594 
\f0  nova resposta complement\'e0ria\
#   /nou 
\f1 \uc0\u8594 
\f0  reinicia context\
\
## Mode: Amplia\
# Entrada t\'edpica: /amplia\
#\
# Proc\'e9s:\
#   - Mant\'e9 mateix tema i poble\
#   - Nova cerca FAISS excloent articles ja retornats\
#   - M\'e0xim 3500 car\'e0cters\
#   - Si no hi ha informaci\'f3 nova 
\f1 \uc0\u8594 
\f0  indica-ho expl\'edcitament\
#\
# Format:\
#   [Mode: Cerca]\
#   [Tasca: Amplia | Tema: \{tema\} | Poble: \{poble\}]\
#   <text nou o ampliaci\'f3>\
#\
# Sortida:\
#   /nou 
\f1 \uc0\u8594 
\f0  reinicia context\
#   /mix 
\f1 \uc0\u8594 
\f0  passa a Mix\
#   /id 
\f1 \uc0\u8594 
\f0  passa a Investigaci\'f3\
\
# ----------------------------------------------------------\
# 8. PAGINACI\'d3\
# ----------------------------------------------------------\
# - Missatge m\'e0xim: 2500 car\'e0cters (3500 per Mix/Amplia)\
# - Format peu:\
#   P\'e0g. X de Y. Per continuar /mes\
# - El bot recorda la p\'e0gina per user_id\
\
# ----------------------------------------------------------\
# 9. COMANDES GLOBALS\
# ----------------------------------------------------------\
# /start       
\f1 \uc0\u8594 
\f0  inicia sessi\'f3 i presentaci\'f3\
# /ajuda       
\f1 \uc0\u8594 
\f0  mostra ordres i modes\
# /poble X     
\f1 \uc0\u8594 
\f0  canvia filtre de poble per defecte\
# /tots        
\f1 \uc0\u8594 
\f0  cerca en tot el corpus\
# /ribera      
\f1 \uc0\u8594 
\f0  equivalent a /tots\
# /mix a b t   
\f1 \uc0\u8594 
\f0  mode Mix amb tema\
# /amplia      
\f1 \uc0\u8594 
\f0  amplia l\'92\'faltima resposta\
# /mes         
\f1 \uc0\u8594 
\f0  mostra p\'e0gina seg\'fcent\
# /nou         
\f1 \uc0\u8594 
\f0  reinicia context\
# /id (ex. /23)
\f1 \uc0\u8594 
\f0  entra a mode Investigaci\'f3\
\
# ----------------------------------------------------------\
# 10. FORMAT DE RESPOSTA LLARG\
# ----------------------------------------------------------\
# Exemple Cerca:\
# [Mode: Cerca]\
# [Tasca: Resum | Tema: Castells | Poble: Ginestar]\
#\
# <resum text>\
#\
# P\'e0g. 1 de 3. /mes per continuar\
#\
# Articles consultats:\
# /23 Castell de Miravet (Pes: 12,5)\
# /14 Coves del Salt de la Gl\'f2ria (Pes: 2,7)\
# (enlla\'e7os clicables)\
\
# ----------------------------------------------------------\
# 11. PUNTS CLAU\
# ----------------------------------------------------------\
# - Filtratge per poble abans de la cerca sem\'e0ntica\
# - Embeddings inclouen "population" + "topics" + text resum\
# - FAISS Index amb IDs per acc\'e9s directe\
# - Scores mostrats al footer\
# - Gesti\'f3 de sessi\'f3 amb timeout de 1h\
# - Paginaci\'f3 autom\'e0tica i comanda /mes\
# - Mix i Amplia controlats pel mateix format\
# - Amplia evita repetir articles ja mostrats\
\
# ----------------------------------------------------------\
# 12. FLUX DE TRANSICIONS I DIAGRAMA L\'d2GIC\
# ----------------------------------------------------------\
# \uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 \
# \uc0\u9474    /start    \u9474 \
# \uc0\u9492 \u9472 \u9472 \u9472 \u9472 \u9472 
\f3 \'a9\'d0
\f0 \uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9496 \
#       
\f1 \uc0\u8595 
\f0 \
# \uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 \
# \uc0\u9474    conversa  \u9474 \
# \uc0\u9492 \u9472 \u9472 \u9472 \u9472 \u9472 
\f3 \'a9\'d0
\f0 \uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9496 \
#       
\f1 \uc0\u8595 
\f0  (pregunta factual)\
# \uc0\u9484 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9488 \
# \uc0\u9474     cerca    \u9474 \
# \uc0\u9492 \u9472 \u9472 \u9472 \u9472 \u9472 
\f3 \'a9\'d0
\f0 \uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9496 \
#  \uc0\u9474     \u9474      \u9474 \
#  \uc0\u9474     \u9474      
\f3 \'a9\'c0
\f0 \uc0\u9472 \u9472  /id 
\f1 \uc0\u8594 
\f0  investigaci\'f3\
#  \uc0\u9474     \u9474      
\f3 \'a9\'c0
\f0 \uc0\u9472 \u9472  /mix 
\f1 \uc0\u8594 
\f0  mix\
#  \uc0\u9474     \u9474      
\f3 \'a9\'c0
\f0 \uc0\u9472 \u9472  /amplia 
\f1 \uc0\u8594 
\f0  amplia\
#  \uc0\u9474     \u9474      \u9492 \u9472 \u9472  /nou 
\f1 \uc0\u8594 
\f0  conversa\
#  
\f1 \uc0\u8595 
\f0 \
# (resultat)\
#\
# INVESTIGACI\'d3 
\f1 \uc0\u8594 
\f0  /amplia | /mix | /nou\
# MIX 
\f1 \uc0\u8594 
\f0  /amplia | /nou\
# AMPLIA 
\f1 \uc0\u8594 
\f0  /nou | /mix | /id\
\
# ----------------------------------------------------------\
# 12.9. NOTES FINALS\
# ----------------------------------------------------------\
# - Cada mode t\'e9 cap\'e7alera i peu, excepte conversa\
# - Transicions controlades per text o comandes\
# - Sessi\'f3 persisteix per user_id fins a timeout o /start\
# - IA pot inferir autom\'e0ticament el mode si el text ho permet\
# - Objectiu: flux natural per\'f2 estructurat\
############################################################\
\
\
\
\
############################################################\
# MisCEREbot \'96 Refer\'e8ncia r\'e0pida de modes i comandes\
############################################################\
\
# MODES PRINCIPALS\
# ---------------\
\
# 1. Conversa\
# - Respostes curtes i informals\
# - Sense header ni footer\
# - Pregunta factual detectada 
\f1 \uc0\u8594 
\f0  passa autom\'e0ticament a Cerca\
\
# 2. Cerca\
# - Entrada: /poble tema, "qu\'e8 saps de X", "parlam de Y a poble"\
# - Filtra per poble, genera embedding, cerca sem\'e0ntica FAISS\
# - Retorna top_k resultats i resum unificat \uc0\u8804 2500c\
# - Header: [Mode: Cerca] [Tasca: Resum | Tema: X | Poble: Y]\
# - Footer: articles consultats amb pes\
# - Transicions:\
#    /id 
\f1 \uc0\u8594 
\f0  Investigaci\'f3\
#    /mix 
\f1 \uc0\u8594 
\f0  Mix\
#    /amplia 
\f1 \uc0\u8594 
\f0  Amplia\
#    /nou 
\f1 \uc0\u8594 
\f0  Conversa\
\
# 3. Investigaci\'f3\
# - Entrada: /id\
# - Mostra summary_long paginat \uc0\u8804 2500c\
# - Header: [Mode: Investigaci\'f3] [Tema: /id \'96 T\'edtol]\
# - Footer: P\'e0g. X de Y /mes, /nou per canviar tema\
# - Preguntes internes 
\f1 \uc0\u8594 
\f0  cerca dins summary_long\
# - Sortida: /nou 
\f1 \uc0\u8594 
\f0  Cerca, /mix 
\f1 \uc0\u8594 
\f0  Mix, /amplia 
\f1 \uc0\u8594 
\f0  Amplia\
\
# 4. Mix\
# - Entrada: /mix id1 id2 [tema]\
# - Un par\'e0graf per article + conclusi\'f3 comuna \uc0\u8804 3500c\
# - Header: [Mode: Mix] [Tasca: Mix | Tema: X]\
# - Sortida: /amplia 
\f1 \uc0\u8594 
\f0  nova ampliaci\'f3, /nou 
\f1 \uc0\u8594 
\f0  reinicia context\
\
# 5. Amplia\
# - Entrada: /amplia\
# - Mant\'e9 tema/poble, busca informaci\'f3 nova no repetida \uc0\u8804 3500c\
# - Header: [Mode: Cerca] [Tasca: Amplia | Tema: X | Poble: Y]\
# - Sortida: /nou 
\f1 \uc0\u8594 
\f0  reinicia context, /mix 
\f1 \uc0\u8594 
\f0  Mix, /id 
\f1 \uc0\u8594 
\f0  Investigaci\'f3\
\
# PAGINACI\'d3\
# ----------\
# - Missatge m\'e0xim: 2500c (3500c Mix/Amplia)\
# - Format peu: P\'e0g. X de Y /mes\
# - El bot recorda p\'e0gina per user_id\
\
# COMANDES PRINCIPALS\
# -------------------\
# /start 
\f1 \uc0\u8594 
\f0  Inicia sessi\'f3 i presentaci\'f3\
# /ajuda 
\f1 \uc0\u8594 
\f0  Mostra ordres i modes\
# /nou 
\f1 \uc0\u8594 
\f0  Reinicia context\
# /mes 
\f1 \uc0\u8594 
\f0  Mostra p\'e0gina seg\'fcent\
# /poble X 
\f1 \uc0\u8594 
\f0  Canvia filtre per defecte\
# /tots o /ribera 
\f1 \uc0\u8594 
\f0  Cerca en tot el corpus\
# /mix id1 id2 [tema] 
\f1 \uc0\u8594 
\f0  Mode Mix amb tema\
# /amplia 
\f1 \uc0\u8594 
\f0  Amplia \'faltima resposta\
# /id 
\f1 \uc0\u8594 
\f0  Entra a mode Investigaci\'f3\
\
# FLUX DE TRANSICIONS\
# -------------------\
# /start 
\f1 \uc0\u8594 
\f0  conversa\
# conversa 
\f1 \uc0\u8594 
\f0  pregunta factual 
\f1 \uc0\u8594 
\f0  cerca\
# cerca 
\f1 \uc0\u8594 
\f0  /id 
\f1 \uc0\u8594 
\f0  Investigaci\'f3\
#       
\f1 \uc0\u8594 
\f0  /mix 
\f1 \uc0\u8594 
\f0  Mix\
#       
\f1 \uc0\u8594 
\f0  /amplia 
\f1 \uc0\u8594 
\f0  Amplia\
#       
\f1 \uc0\u8594 
\f0  /nou 
\f1 \uc0\u8594 
\f0  conversa\
# Investigaci\'f3 
\f1 \uc0\u8594 
\f0  /amplia | /mix | /nou\
# Mix 
\f1 \uc0\u8594 
\f0  /amplia | /nou\
# Amplia 
\f1 \uc0\u8594 
\f0  /nou | /mix | /id\
\
# PUNTS CLAU\
# ----------\
# - Embeddings inclouen population + topics + title + summary + summary_long\
# - Filtratge per poble abans de cerca\
# - FAISS amb IDs per acc\'e9s directe\
# - Scores mostrats al footer\
# - Sessi\'f3 per user_id\
# - Paginaci\'f3 autom\'e0tica i /mes\
# - Amplia evita repetir articles\
\
############################################################\
# Fi de refer\'e8ncia r\'e0pida\
############################################################\
\
\
\
\
\
\
\
\
\
\
\
"\
/AJUDA:\
\
\
############################################################\
# MisCEREbot \'96 Comandes R\'e0pides\
############################################################\
\
Benvingut a MisCEREbot! 
\f2 \uc0\u55358 \u56598 
\f0 \
Bot d\'92investigaci\'f3 acad\'e8mica sobre la Ribera d\'92Ebre.\
\
\uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \
COMANDES PRINCIPALS\
\uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \
\
/start           
\f1 \uc0\u8594 
\f0  Inicia sessi\'f3 i mostra benvinguda\
/ajuda           
\f1 \uc0\u8594 
\f0  Mostra aquesta ajuda\
/nou             
\f1 \uc0\u8594 
\f0  Reinicia context\
/mes             
\f1 \uc0\u8594 
\f0  Mostra seg\'fcent p\'e0gina\
/poble X         
\f1 \uc0\u8594 
\f0  Canvia filtre de poble\
/tots o /ribera  
\f1 \uc0\u8594 
\f0  Cerca en tot el corpus\
/mix id1 id2 [tema] 
\f1 \uc0\u8594 
\f0  Compara dos articles (Mix)\
/amplia          
\f1 \uc0\u8594 
\f0  Amplia la resposta anterior\
/id              
\f1 \uc0\u8594 
\f0  Mostra resum llarg d\'92un article concret\
\
\uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \
EXEMPLES D\'92\'daS\
\uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \
\
/asco arqueologia\

\f1 \uc0\u8594 
\f0  Cerca articles sobre arqueologia a Asc\'f3\
\
/mix 23 9 arqueologia\

\f1 \uc0\u8594 
\f0  Compara els articles 23 i 9 amb resum i conclusi\'f3 comuna\
\
/amplia\

\f1 \uc0\u8594 
\f0  Afegeix informaci\'f3 nova al tema anterior\
\
/23\

\f1 \uc0\u8594 
\f0  Mostra el resum llarg de l\'92article 23 (mode Investigaci\'f3)\
\
\uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \
POBLES ADMESOS\
\uc0\u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \u9472 \
\
Asc\'f3, Benissanet, Flix, Garcia, Ginestar, Miravet,\
M\'f3ra d'Ebre, M\'f3ra la Nova, Palma d'Ebre, la,\
Rasquera, Riba-roja d'Ebre, Tivissa,\
Torre de l'Espanyol, la, Vinebre\
\
############################################################\
\
"\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
\
############################################################\
MisCEREbot \'96 Fulla de ruta i document d\'92estil complet\
############################################################\
\
PROJECTE: MisCEREbot \'96 Bot de Telegram d\'92investigaci\'f3 acad\'e8mica sobre la Ribera d\'92Ebre\
DATA: 2025-10-11\
AUTOR: [Nom del desenvolupador]\
\
== OBJECTIU ==\
Crear un bot de Telegram amb IA (RAG + LLM) capa\'e7 de cercar, resumir i comparar articles acad\'e8mics sobre la Ribera d\'92Ebre. Ha de ser capa\'e7 de gestionar sessions d\'92usuari, paginaci\'f3, diferents modes (Conversa, Cerca, Investigaci\'f3, Mix, Amplia), filtratge per poble i generaci\'f3 de resums autom\'e0tics o llistats.\
\
== ESPECIFICACIONS ORIGINALS ==\
- Corpus JSONL amb articles: id, title, author, population, topics, language, years, filename, summary_long, summary.\
- Poblacions admeses: ["Asc\'f3","Benissanet","Flix","Garcia","Ginestar","Miravet","M\'f3ra d'Ebre","M\'f3ra la Nova","Palma d'Ebre, la","Rasquera","Riba-roja d'Ebre","Tivissa","Torre de l'Espanyol, la","Vinebre"]\
- Embeddings pre-generats amb OpenAI (text-embedding-3-small)\
- FAISS index creat amb IDs per acc\'e9s directe\
- Modes: Conversa, Cerca, Investigaci\'f3, Mix, Amplia\
- Comandes: /start, /ajuda, /nou, /mes, /poble X, /tots, /ribera, /mix, /amplia, /id\
- Paginaci\'f3: 2500 car\'e0cters m\'e0xim, 3500 per Mix/Amplia\
- Timeout de sessi\'f3: 1h\
- Footer amb llista d\'92articles consultats amb score i clicable via /id\
\
== AN\'c0LISI I INTERPRETACI\'d3 ==\
- Python 3.11 recomanat\
- Llibreries essencials: python-telegram-bot, faiss-cpu, numpy, openai, dotenv\
- Sessions en mem\'f2ria de moment (no Redis)\
- Embeddings ja pre-generats i carregats a arrencada 
\f1 \uc0\u8594 
\f0  evita crides repetides a OpenAI\
- Cerca sem\'e0ntica FAISS amb filtratge per poble abans de la cerca per optimitzar\
- Modes autom\'e0tics inferits via LLM segons intenci\'f3, a m\'e9s de comandes expl\'edcites\
- Paginaci\'f3 controlada amb `/mes`, truncament de missatges i manteniment de p\'e0gina per user_id\
- Logging b\'e0sic a consola: mostra missatge de l\'92usuari i llista d\'92IDs dels articles consultats `[z, y, z, k]`\
\
== ENTRADES I SORTIDES ==\
- Entrades: comandes Telegram, preguntes en text lliure, filtratge per poble/tema\
- Sortides: missatges Telegram amb header, resum o llistat, footer amb articles i score\
- Resums \uc0\u8804 2500 car\'e0cters per Cerca i Investigaci\'f3, \u8804 3500 per Mix/Amplia\
- Llistats d\'92articles ordenats per score amb `/id` clicable\
\
== FUNCIONS I CLASSES (ESB\'d3S) ==\
- `IntentRouter`: detecta mode segons comanda o text lliure\
- `RetrievalLayer`: cerca sem\'e0ntica amb FAISS i filtratge opcional per poble\
- `ResponseComposer`: genera respostes segons mode (resum, llistat, Mix, Amplia)\
- `SessionManager`: gestiona sessions per user_id, timeout 1h\
- `TelegramBotHandler`: integraci\'f3 amb API Telegram, gesti\'f3 de comandes i callbacks\
- Funcions auxiliars: paginaci\'f3 (`/mes`), ampliaci\'f3 (`/amplia`), reinici context (`/nou`), mode Mix (`/mix`), investigaci\'f3 (`/id`)\
\
== LLIBRERIES I ENTORN ==\
- Python 3.11\
- openai >=1.0\
- faiss-cpu\
- numpy\
- python-telegram-bot\
- dotenv\
- Railway compatible, m\'ednimes depend\'e8ncies addicionals\
\
== CONTROL D\'92ERRORS I LOGGING ==\
- Excepcions d\'92OpenAI amb fallback (zeros en embeddings si falla)\
- Logs a consola: entrada usuari + articles consultats\
- Futur: logging avan\'e7at opcional amb timestamps, errors i metadades\
\
== TESTS ==\
- Comprovaci\'f3 carregament corpus i embeddings\
- Cerca FAISS amb filtre per poble i sense\
- Generaci\'f3 de resums unificats per top_k resultats\
- Paginaci\'f3 i continuaci\'f3 amb `/mes`\
- Modes: Conversa 
\f1 \uc0\u8594 
\f0  Cerca 
\f1 \uc0\u8594 
\f0  Investigaci\'f3 
\f1 \uc0\u8594 
\f0  Mix 
\f1 \uc0\u8594 
\f0  Amplia\
- Footer amb articles i score clicable\
- Timeout de sessi\'f3 i reinici autom\'e0tic\
\
== POSSIBLES EXTENSIONS ==\
- Sessions persistents amb Redis\
- Suport multiling\'fce amb `/english` i traducci\'f3 din\'e0mica amb LLM\
- Logging avan\'e7at i seguiment de consultes\
- Interf\'edcie web/API per consulta remota o integraci\'f3 amb altres serveis\
- Optimitzaci\'f3 FAISS amb sub-index per filtre poble i top_k din\'e0mic\
\
== PREGUNTES OBERTES / PUNTOS A CONFIRMAR (DE MOMENT) ==\
- Traducci\'f3 din\'e0mica futura `/english`\
- Integraci\'f3 de Redis per persist\'e8ncia i escalabilitat\
- Llibreries optimitzades per entorn Railway\
- Policies de limitaci\'f3 de tokens i crides OpenAI per cost\
\
== CONCLUSI\'d3 ==\
- Projecte clarament estructurat amb modes, comandes, filtratge, paginaci\'f3 i resum autom\'e0tic\
- Sessi\'f3 i logging b\'e0sics implementables amb m\'ednimes depend\'e8ncies\
- Fulla de ruta detallada llesta per a desenvolupament iteratiu i futur escalable\
- Prioritzar implementaci\'f3 funcional inicial en catal\'e0 amb sessions en mem\'f2ria, resums autom\'e0tics, cerca sem\'e0ntica i modes complets\
\
############################################################\
Fi del document\
############################################################\
\
\
\
\
\
}